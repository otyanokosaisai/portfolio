---
import Section from "../Section.astro";
import { work } from "@cv";
import { Icon } from "astro-icon/components";

// ----- Types -----
type WorkItem = {
  name: string;
  position: string;
  location?: string;
  location_type?: string;
  url?: string;
  startDate: string; // e.g. "Aug 2025"
  endDate?: string;  // e.g. "Oct 2025" or undefined
  summary?: string | string[];
  achievements?: string[];
  skills?: Record<string, string>;
};

const items: WorkItem[] = work;
---

<Section className={Astro.props.className} title="Experience">
  <ul class="flex flex-col">
    {
      items.map((item) => {
        const {
          name,
          position,
          startDate,
          endDate,
          summary,
          achievements,
          url,
          skills,
          location,
          location_type,
        } = item;

        const dateText = `${startDate} â€“ ${endDate ?? "Present"}`;

        return (
          <li class="relative print:py-2">
            <div
              data-expanded="false"
              class="group expand-container relative grid pb-1 print:pb-0 transition-all print:grid-cols-1 print:gap-1 sm:grid-cols-12 sm:gap-8 md:gap-6"
            >
              <!-- Left Column: Date -->
              <div class="relative mt-1 text-xs font-semibold sm:col-span-2">
                {dateText}
              </div>

              <!-- Right Column -->
              <div class="relative flex flex-col pb-6 print:pb-0 before:-ml-6 sm:col-span-10 before:w-px before:absolute before:bg-skin-muted before:h-full before:mt-2 print:before:hidden">
                <div class="absolute w-2 h-2 bg-skin-muted rounded-full mt-2 -translate-x-[1.71rem] ring print:hidden ring-skin-fill"></div>

                <!-- Position + Company -->
                <h3>
                  <span
                    class="inline-flex items-center text-lg print:text-base leading-tight group/link"
                  >
                    {position} <span>@</span>
                    {url ? (
                      <a
                        data-ccursor
                        class="text-skin-hue inline-block w-max"
                        href={url}
                        target="_blank"
                      >
                        {name}
                      </a>
                    ) : (
                      <span>{name}</span>
                    )}
                    {url && (
                      <Icon
                        name="ri:arrow-up-line"
                        class="inline-block w-4 h-4 ml-1 translate-y-px transition-transform group-hover/link:-translate-y-1 group-hover/link:translate-x-1 rotate-45"
                      />
                    )}
                  </span>
                </h3>

                <!-- Location -->
                {(location || location_type) && (
                  <div class="text-xs text-skin-muted">
                    {location} {location && location_type && "-"} {location_type}
                  </div>
                )}

                <!-- Summary -->
                {summary && (
                  <div class="mt-4 flex flex-col gap-1">
                    <h4 class="print:font-bold underline underline-offset-4 decoration-skin-hue">Summary</h4>
                    <ul class="text-skin-muted list-disc ml-8 flex flex-col gap-2">
                      {Array.isArray(summary) ? (
                        summary.map((s) => <li>{s}</li>)
                      ) : (
                        <li>{summary}</li>
                      )}
                    </ul>
                  </div>
                )}

                <!-- Achievements Expandable -->
                {achievements && (
                  <div
                    class="mt-4 relative flex flex-col gap-4 h-16 overflow-hidden group-data-[expanded=true]:h-auto after:bg-gradient-to-t after:from-skin-hue after:absolute after:bottom-0 after:w-full after:h-12 after:content-[''] group-data-[expanded=true]:after:hidden"
                  >
                    <h4 class="print:font-bold underline underline-offset-4 decoration-skin-hue">Achievements</h4>
                    <ul class="text-skin-muted list-disc ml-8 flex flex-col gap-2">
                      {achievements.map((r) => (
                        <li>{r}</li>
                      ))}
                    </ul>
                  </div>
                )}

                {achievements && (
                  <button
                    class="print:hidden expand-button w-fit flex items-center gap-1.5 text-xs underline text-skin-muted hover:text-skin-inverted transition-all"
                  >
                    <span class="expand-text">Show more</span>
                    <Icon
                      name="ri:arrow-up-s-line"
                      class="w-4 h-4 duration-200 group-data-[expanded=true]:rotate-180"
                    />
                  </button>
                )}

                <!-- Skills -->
                {skills && (
                  <ul class="flex flex-wrap gap-2 mt-4 print:hidden">
                    {Object.entries(skills).map(([label, icon]) => (
                      <li class="px-2 py-0.5 text-xs rounded-md border border-skin-hue/20 bg-skin-button-accent/20 flex items-center gap-1">
                        <Icon name={icon} width={16} height={16} />
                        <span>{label}</span>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>
          </li>
        );
      })
    }
  </ul>
</Section>

<script>
  const buttons = document.querySelectorAll(".expand-button");

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const container = btn.closest(".expand-container") as HTMLElement | null;
      if (!container) return;

      container.dataset.expanded =
        container.dataset.expanded === "true" ? "false" : "true";

      const text = btn.querySelector(".expand-text") as HTMLElement | null;
      if (text) {
        text.textContent =
          container.dataset.expanded === "true" ? "Show less" : "Show more";
      }
    });
  });
</script>

<style>
  li::marker {
    @apply text-skin-hue;
  }
  h4 {
    @apply max-w-min px-2;
  }
</style>
